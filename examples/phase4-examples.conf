# Copyright (c) 2025 by L2C2 Technologies. All rights reserved.
# 
# For licensing inquiries, contact:
# Indranil Das Gupta <indradg@l2c2.co.in>

#
# Component D (ukabu-extras) nginx Configuration Examples
# These snippets show how XFF and search engine detection are integrated
#

# ============================================================================
# XFF (X-Forwarded-For) Handling
# ============================================================================

# Geo map for trusted proxies (auto-generated from CDN IP lists)
geo $trusted_proxy {
    default 0;
    
    # Auto-updated CDN ranges (updated daily by systemd timer)
    include /etc/ukabu/config/trusted_proxies_cloudflare.conf;
    include /etc/ukabu/config/trusted_proxies_aws.conf;
    include /etc/ukabu/config/trusted_proxies_google.conf;
    include /etc/ukabu/config/trusted_proxies_digitalocean.conf;
    
    # Custom proxies (manually configured via ukabu-manager)
    include /etc/ukabu/config/trusted_proxies_custom.conf;
}

# Extract real client IP based on XFF (only if from trusted proxy)
# Per-domain XFF handling
map $host:$trusted_proxy $real_client_ip {
    # Domain with XFF enabled
    ~^cdn-site\.com:1$ $http_x_forwarded_for;
    
    # All other cases: use direct IP
    default $remote_addr;
}

# Alternative: Simple XFF extraction (use rightmost non-trusted IP)
# This handles multiple proxy hops correctly
map $http_x_forwarded_for $xff_real_ip {
    # Extract last IP from XFF header (rightmost before trusted proxy)
    ~^(?<client_ip>[^,]+)$ $client_ip;
    default $http_x_forwarded_for;
}

# Final real IP determination (combines XFF and direct)
map $trusted_proxy:$xff_real_ip $final_real_ip {
    ~^1:(.+)$ $1;              # From trusted proxy: use XFF
    default $remote_addr;       # Not from trusted proxy: use direct IP
}


# ============================================================================
# Search Engine Detection
# ============================================================================

# Google bot detection (IP whitelist - fast)
geo $is_google_bot {
    default 0;
    
    # Auto-updated Google IP ranges (updated daily by systemd timer)
    include /etc/ukabu/config/search_engines_google.conf;
}

# Search engine detection map
map $is_google_bot $search_engine_detected {
    1 "google";              # Google verified by IP
    default 0;               # Not a search engine
}

# Combined search engine + bot detection
# Note: Bing verification happens in daemon (reverse DNS)
map $http_user_agent $is_likely_bot {
    ~*googlebot 1;
    ~*bingbot 1;
    ~*slurp 1;               # Yahoo
    ~*duckduckbot 1;
    ~*baiduspider 1;
    ~*yandexbot 1;
    default 0;
}


# ============================================================================
# Enhanced Logging (Component D (ukabu-extras))
# ============================================================================

# Enhanced log format with Component D (ukabu-extras) additions
log_format combined_enhanced '$host $remote_addr - $remote_user [$time_iso8601] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent" '
                             '"$ukabu_status" "$ukabu_decision" "$strike_type" '
                             '"$http_x_forwarded_for" "$request_id" '
                             '$request_time $upstream_response_time '
                             '"$ssl_protocol" "$ssl_cipher" '
                             '"$real_client_ip" "$search_engine_detected"';

# ML extraction log format (optional - for dedicated ML log file)
log_format ml_extract '{'
                      '"timestamp":"$time_iso8601",'
                      '"ip":"$real_client_ip",'
                      '"domain":"$host",'
                      '"method":"$request_method",'
                      '"path":"$request_uri",'
                      '"status":$status,'
                      '"ukabu_status":"$ukabu_status",'
                      '"user_agent":"$http_user_agent",'
                      '"request_time":$request_time,'
                      '"upstream_time":$upstream_response_time,'
                      '"ssl_protocol":"$ssl_protocol",'
                      '"ssl_cipher":"$ssl_cipher",'
                      '"request_id":"$request_id",'
                      '"search_engine":"$search_engine_detected"'
                      '}';


# ============================================================================
# Example Vhost Integration
# ============================================================================

# Example 1: Domain behind Cloudflare with XFF enabled
server {
    listen 443 ssl http2;
    server_name cdn-site.com;
    
    # SSL configuration
    ssl_certificate /etc/ssl/certs/cdn-site.com.crt;
    ssl_certificate_key /etc/ssl/private/cdn-site.com.key;
    
    # UKABU includes
    include /etc/ukabu/includes/config.conf;
    include /etc/ukabu/includes/endpoints.inc;
    include /etc/ukabu/includes/enforcement.inc;
    
    # Use real_client_ip for enforcement
    # (automatically handled in enforcement.inc when XFF enabled)
    
    # Access log with enhanced format
    access_log /var/log/nginx/cdn-site.com-access.log combined_enhanced;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $real_client_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Example 2: Domain with direct connection (no XFF)
server {
    listen 443 ssl http2;
    server_name direct-site.com;
    
    # SSL configuration
    ssl_certificate /etc/ssl/certs/direct-site.com.crt;
    ssl_certificate_key /etc/ssl/private/direct-site.com.key;
    
    # UKABU includes
    include /etc/ukabu/includes/config.conf;
    include /etc/ukabu/includes/endpoints.inc;
    include /etc/ukabu/includes/enforcement.inc;
    
    # Access log
    access_log /var/log/nginx/direct-site.com-access.log combined_enhanced;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
    }
}


# ============================================================================
# Search Engine Bypass Example
# ============================================================================

# In enforcement.inc, search engines bypass PoW:
#
# if ($search_engine_detected != "0") {
#     set $ukabu_status "102";
#     set $ukabu_decision "search_engine";
#     # Allow access, no PoW required
# }


# ============================================================================
# ML Extraction Usage
# ============================================================================

# After logs are collected, extract ML dataset:
#
# # Extract last 24 hours to JSON
# sudo ukabu-manager ml extract --format json --output /tmp/dataset.json --hours 24
#
# # Extract specific domain to CSV
# sudo ukabu-manager ml extract --format csv --output /tmp/cdn-site.csv \
#   --domains cdn-site.com --days 7
#
# # Extract only challenged requests
# sudo ukabu-manager ml extract --format json --output /tmp/challenges.json \
#   --ukabu-status 200,201 --hours 48
