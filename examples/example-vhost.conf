# ========================================
# UKABU WAF v1.0 - Component A (ukabu-core)
# Example Virtual Host Configuration
# Copyright (c) 2025 by L2C2 Technologies. All rights reserved.
# ========================================
#
# This example shows how to integrate UKABU into nginx vhost
# Based on Koha OPAC but applicable to any web application
#
# ========================================

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name example.com www.example.com;
    
    return 301 https://$host$request_uri;
}

# Main HTTPS server with UKABU protection
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # ────────────────────────────────────────────────────────────
    # SSL Configuration
    # ────────────────────────────────────────────────────────────
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # ────────────────────────────────────────────────────────────
    # UKABU WAF Integration (3 lines!)
    # ────────────────────────────────────────────────────────────
    
    # Include UKABU endpoints (/ukabu_verify, /ukabu_challenge, etc.)
    include /etc/ukabu/includes/endpoints.inc;
    
    # ────────────────────────────────────────────────────────────
    # Main Location Block
    # ────────────────────────────────────────────────────────────
    
    location / {
        # UKABU enforcement (priority-based access control)
        include /etc/ukabu/includes/enforcement.inc;
        
        # Proxy to upstream application
        # Replace with your actual backend
        proxy_pass http://127.0.0.1:8080;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Connection settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ────────────────────────────────────────────────────────────
    # Optional: Explicit Static Asset Handling
    # ────────────────────────────────────────────────────────────
    # Note: enforcement.inc already handles path whitelisting
    # These are optional for performance or special handling
    # ────────────────────────────────────────────────────────────
    
    # location /static/ {
    #     alias /var/www/example.com/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }
    
    # ────────────────────────────────────────────────────────────
    # Logging
    # ────────────────────────────────────────────────────────────
    
    access_log /var/log/nginx/example.com-access.log ukabu_combined;
    error_log /var/log/nginx/example.com-error.log warn;
    
    # ────────────────────────────────────────────────────────────
    # Security Headers (Optional but Recommended)
    # ────────────────────────────────────────────────────────────
    
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ────────────────────────────────────────────────────────────
    # Client Limits (Anti-DoS)
    # ────────────────────────────────────────────────────────────
    
    client_max_body_size 50M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;
}

# ════════════════════════════════════════════════════════════════
# TESTING THIS CONFIGURATION
# ════════════════════════════════════════════════════════════════
#
# 1. Test static asset (should NOT require PoW):
#    curl -I https://example.com/static/style.css
#    Expected: 200 OK, X-Ukabu-Status: 100
#
# 2. Test protected page (should require PoW):
#    curl -I -H "User-Agent: Mozilla/5.0" https://example.com/
#    Expected: 302 redirect to /ukabu_verify, X-Ukabu-Status: 200
#
# 3. Test from browser:
#    Visit https://example.com/ in Firefox/Chrome
#    Should see PoW challenge, then redirect to /
#
# 4. Test blocked path:
#    curl -I https://example.com/wp-admin/
#    Expected: 444, X-Ukabu-Status: 002
#
# 5. Test whitelisted IP:
#    curl -I https://example.com/ -H "X-Forwarded-For: 192.168.1.100"
#    Expected: 200 OK, X-Ukabu-Status: 101
#    (only if IP is in ip_whitelist.conf)
#
# ════════════════════════════════════════════════════════════════
