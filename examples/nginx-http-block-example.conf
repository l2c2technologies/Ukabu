# ========================================
# UKABU WAF v1.0 - Component A (ukabu-core)
# nginx.conf HTTP Block Configuration
# Copyright (c) 2025 by L2C2 Technologies. All rights reserved.
# ========================================
#
# Add these directives to your nginx.conf http{} block
# Location: /etc/nginx/nginx.conf (Debian/Ubuntu)
#          /etc/nginx/nginx.conf (RHEL/CentOS/Rocky)
#
# ========================================

http {
    # ────────────────────────────────────────────────────────────
    # Load NJS Module (REQUIRED)
    # ────────────────────────────────────────────────────────────
    # Must be at the top of http{} block
    # ────────────────────────────────────────────────────────────
    
    # Debian/Ubuntu (automatic with package)
    # include /etc/nginx/modules-enabled/*.conf;
    
    # Or load explicitly:
    # load_module modules/ngx_http_js_module.so;
    
    # ────────────────────────────────────────────────────────────
    # Include UKABU Configuration (REQUIRED)
    # ────────────────────────────────────────────────────────────
    # This loads all UKABU variables and maps
    # ────────────────────────────────────────────────────────────
    
    include /etc/ukabu/includes/config.conf;
    
    # ────────────────────────────────────────────────────────────
    # Rate Limiting Zones (REQUIRED for UKABU endpoints)
    # ────────────────────────────────────────────────────────────
    # Prevents flooding of challenge/validate endpoints
    # ────────────────────────────────────────────────────────────
    
    limit_req_zone $binary_remote_addr zone=ukabu_challenge:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=ukabu_validate:10m rate=3r/s;
    
    # ────────────────────────────────────────────────────────────
    # Standard nginx Configuration
    # ────────────────────────────────────────────────────────────
    
    # Basic Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;
    
    # MIME Types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log ukabu_combined;
    error_log /var/log/nginx/error.log warn;
    
    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    
    # ────────────────────────────────────────────────────────────
    # Virtual Hosts
    # ────────────────────────────────────────────────────────────
    
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}

# ════════════════════════════════════════════════════════════════
# VERIFICATION
# ════════════════════════════════════════════════════════════════
#
# After adding these directives:
#
# 1. Test configuration:
#    sudo nginx -t
#
# 2. Check for UKABU config loaded:
#    sudo nginx -T | grep "js_import pow"
#    sudo nginx -T | grep "ukabu_combined"
#
# 3. Reload nginx:
#    sudo systemctl reload nginx
#
# ════════════════════════════════════════════════════════════════
