# ========================================
# UKABU WAF v1.0 - Component A (ukabu-core)
# nginx Configuration: Variables and Maps
# Copyright (c) 2025 by L2C2 Technologies. All rights reserved.
# ========================================
#
# This file should be included in the http{} block of nginx.conf:
#   http {
#       include /etc/ukabu/includes/config.conf;
#       ...
#   }
#
# ========================================

# ────────────────────────────────────────────────────────────────
# NJS Module Configuration
# ────────────────────────────────────────────────────────────────

js_path "/etc/ukabu/njs/";
js_import pow from pow-challenge.js;

# ────────────────────────────────────────────────────────────────
# Global Variables (Read from domains.json via external script)
# ────────────────────────────────────────────────────────────────
# Note: Component C (ukabu-manager) CLI will auto-generate these maps from domains.json
# For Component A (ukabu-core), edit these maps manually
# ────────────────────────────────────────────────────────────────

# Default values
map $host $pow_difficulty_default {
    default 18;
}

map $host $pow_cookie_duration_default {
    default 604800;  # 7 days in seconds
}

# ────────────────────────────────────────────────────────────────
# Domain Protection Status
# ────────────────────────────────────────────────────────────────
# Is this domain protected by UKABU?
# 1 = protected, 0 = not protected
# ────────────────────────────────────────────────────────────────

map $host $pow_protected {
    default 0;
    
    # Add your protected domains here
    # Example:
    # example.com 1;
    # www.example.com 1;
    # api.example.com 1;
}

# ────────────────────────────────────────────────────────────────
# Per-Domain Configuration
# ────────────────────────────────────────────────────────────────

# HMAC Secret Files (per-domain)
map $host $pow_hmac_secret_file {
    default "";
    
    # Add your domains here
    # Example:
    # example.com /etc/ukabu/secrets/example.com.key;
    # www.example.com /etc/ukabu/secrets/example.com.key;
}

# PoW Difficulty (bits)
map $host $pow_difficulty {
    default $pow_difficulty_default;
    
    # Override per domain if needed
    # Example:
    # high-security.com 20;
    # low-traffic.com 16;
}

# Cookie Duration (seconds)
map $host $pow_cookie_duration {
    default $pow_cookie_duration_default;
    
    # Override per domain if needed
    # Example:
    # short-session.com 86400;    # 1 day
    # long-session.com 2592000;   # 30 days
}

# ────────────────────────────────────────────────────────────────
# IP Whitelist (Global)
# ────────────────────────────────────────────────────────────────
# IPs/ranges in this list bypass ALL PoW challenges
# File: /etc/ukabu/config/ip_whitelist.conf
# Format: One IP or CIDR per line
# ────────────────────────────────────────────────────────────────

geo $is_ip_whitelisted {
    default 0;
    
    # Read from external file (Component A (ukabu-core): edit manually)
    # Example entries:
    # 192.168.1.0/24 1;
    # 10.0.0.5 1;
    # 203.0.113.100 1;
    
    include /etc/ukabu/config/ip_whitelist.conf;
}

# ────────────────────────────────────────────────────────────────
# IP Blacklist (Global) - Component B (ukabu-monitor)
# ────────────────────────────────────────────────────────────────
# IPs/ranges in this list are blocked via ipset (Component B (ukabu-monitor))
# Component A (ukabu-core): Structure present but not enforced
# ────────────────────────────────────────────────────────────────

geo $is_ip_blacklisted {
    default 0;
    
    # Component B (ukabu-monitor): Will be populated by daemon from ipset
    # Component A (ukabu-core): Can manually add for testing
    # include /etc/ukabu/config/ip_blacklist_generated.conf;
}

# ────────────────────────────────────────────────────────────────
# Path Whitelist (Global)
# ────────────────────────────────────────────────────────────────
# Paths matching these patterns bypass PoW challenge
# Uses prefix matching: /static/* matches /static/css/style.css
# ────────────────────────────────────────────────────────────────

map $uri $is_path_whitelisted {
    default 0;
    
    # Common static assets
    ~^/static/ 1;
    ~^/assets/ 1;
    ~^/images/ 1;
    ~^/css/ 1;
    ~^/js/ 1;
    ~^/fonts/ 1;
    
    # Common files
    /favicon.ico 1;
    /robots.txt 1;
    /sitemap.xml 1;
    
    # Health checks
    /health 1;
    /ping 1;
    
    # Include from external file (Component A (ukabu-core): edit manually)
    include /etc/ukabu/config/path_whitelist.conf;
}

# ────────────────────────────────────────────────────────────────
# Path Blacklist (Global)
# ────────────────────────────────────────────────────────────────
# Paths matching these patterns are blocked (444 response)
# Unless IP is whitelisted
# ────────────────────────────────────────────────────────────────

map $uri $is_path_blacklisted {
    default 0;
    
    # WordPress admin (if not using WordPress)
    ~^/wp-admin/ 1;
    ~^/wp-login\.php 1;
    
    # Common attack targets
    ~^/\.git/ 1;
    ~^/\.env 1;
    ~^/phpmyadmin/ 1;
    ~^/phpMyAdmin/ 1;
    
    # Include from external file (Component A (ukabu-core): edit manually)
    include /etc/ukabu/config/path_blacklist.conf;
}

# ────────────────────────────────────────────────────────────────
# Per-Domain Restricted Paths (Component A (ukabu-core): Simple version)
# ────────────────────────────────────────────────────────────────
# Paths that require specific IP whitelist
# Component A (ukabu-core): Uses simple map, Component C (ukabu-manager) CLI will generate from JSON
# ────────────────────────────────────────────────────────────────

map $host:$uri $is_restricted_path {
    default 0;
    
    # Format: domain:/path/pattern 1;
    # Example:
    # example.com:/admin/ 1;
    # example.com:/wp-admin/ 1;
}

# IPs allowed for restricted paths (per-domain)
map $host:$uri:$remote_addr $is_restricted_ip_allowed {
    default 0;
    
    # Format: domain:/path/:ip 1;
    # Example:
    # example.com:/admin/:192.168.1.100 1;
    # example.com:/admin/:10.0.0.0/8 1;
}

# ────────────────────────────────────────────────────────────────
# Browser Detection
# ────────────────────────────────────────────────────────────────
# Detect if User-Agent looks like a browser
# Component A (ukabu-core): Basic detection
# ────────────────────────────────────────────────────────────────

map $http_user_agent $is_browser {
    default 0;
    
    # Major browsers
    ~*Mozilla 1;
    ~*Chrome 1;
    ~*Safari 1;
    ~*Firefox 1;
    ~*Edge 1;
    ~*Opera 1;
    
    # Mobile browsers
    ~*Mobile 1;
    ~*Android 1;
    ~*iPhone 1;
    ~*iPad 1;
}

# Specific browser detection for custom nojs pages
map $http_user_agent $detected_browser {
    default "generic";
    
    ~*Chrome "chrome";
    ~*Firefox "firefox";
    ~*Edg "edge";  # Edge uses "Edg" in UA
    ~*Safari "safari";
}

# ────────────────────────────────────────────────────────────────
# Search Engine Detection - Component D (ukabu-extras)
# ────────────────────────────────────────────────────────────────
# Component A (ukabu-core): Structure present but always returns 0
# Component D (ukabu-extras): Will verify Google/Bing IPs
# ────────────────────────────────────────────────────────────────

map $remote_addr $is_search_engine {
    default 0;
    
    # Component D (ukabu-extras): Will include verified search engine IPs
    # include /etc/ukabu/config/search_engines_google.conf;
    # include /etc/ukabu/config/search_engines_bing.conf;
}

# ────────────────────────────────────────────────────────────────
# X-Forwarded-For Handling - Component D (ukabu-extras)
# ────────────────────────────────────────────────────────────────
# Component A (ukabu-core): Disabled by default (secure default)
# Always use $remote_addr in Component A (ukabu-core)
# ────────────────────────────────────────────────────────────────

map $host $xff_enabled {
    default 0;
    
    # Component D (ukabu-extras): Will enable per-domain
    # cdn-site.com 1;
}

# Trusted proxy detection (for XFF validation)
geo $is_trusted_proxy {
    default 0;
    
    # Component D (ukabu-extras): Will include CDN IP ranges
    # include /etc/ukabu/config/trusted_proxies_cloudflare.conf;
    # include /etc/ukabu/config/trusted_proxies_aws.conf;
}

# Real client IP (Component A (ukabu-core): always $remote_addr)
map $xff_enabled:$is_trusted_proxy:$http_x_forwarded_for $real_client_ip {
    default $remote_addr;
    
    # Component D (ukabu-extras): Will extract from XFF if enabled and trusted
    # ~^1:1:(.+)$ $1;
}

# For Component A (ukabu-core), always use direct IP
set $client_ip $remote_addr;

# ────────────────────────────────────────────────────────────────
# PoW Token Validation
# ────────────────────────────────────────────────────────────────
# Validates pow_token cookie via NJS module
# Returns 1 if valid, 0 if invalid/missing
# ────────────────────────────────────────────────────────────────

# This will be set by NJS in the enforcement.inc
# map $http_cookie $pow_token_valid {
#     default 0;
# }

# ────────────────────────────────────────────────────────────────
# UKABU Status Codes (for logging)
# ────────────────────────────────────────────────────────────────
# These will be set by enforcement.inc based on decision
# ────────────────────────────────────────────────────────────────

map $uri $ukabu_status {
    default "-";
}

map $uri $ukabu_decision {
    default "-";
}

map $uri $strike_type {
    default "-";
}

# ────────────────────────────────────────────────────────────────
# Request Serial (for ML tracking) - Component D (ukabu-extras)
# ────────────────────────────────────────────────────────────────
# Unique ID for each protected request
# Component A (ukabu-core): Structure present
# ────────────────────────────────────────────────────────────────

map $pow_protected $request_serial {
    default "-";
    1 "$request_id";  # nginx built-in unique ID
}

# ────────────────────────────────────────────────────────────────
# Log Format
# ────────────────────────────────────────────────────────────────

log_format ukabu_combined '$host $remote_addr - $remote_user [$time_iso8601] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          '"$ukabu_status" "$ukabu_decision" "$strike_type" '
                          '"$http_x_forwarded_for" "$request_serial" '
                          '$request_time $upstream_response_time '
                          '"$ssl_protocol" "$ssl_cipher"';

# ────────────────────────────────────────────────────────────────
# END OF CONFIG
# ────────────────────────────────────────────────────────────────
